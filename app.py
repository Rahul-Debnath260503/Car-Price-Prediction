# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1AW93rghlXKX37_VScuBg6wMkP_v-L6or
"""

!pip install streamlit

import streamlit as st
import pandas as pd
import numpy as np
import joblib

# Load the trained XGBoost model
# Make sure the model file is in the same directory or provide the full path
try:
    xgb_model = joblib.load('xgb_model.pkl')
except FileNotFoundError:
    st.error("Model file 'xgb_model.pkl' not found. Please make sure the model file is in the correct directory.")
    st.stop()


# Assuming the columns used for training were stored somewhere or are known
# You might need to adjust this based on how you saved your processed data columns
# For simplicity, let's recreate the columns based on the original notebook's encoding
# This is a crucial step - ensure the columns here exactly match the training columns
# based on the one-hot encoding and dropping of 'name' and 'max_power'
# and the order is the same.

# Define the expected columns after preprocessing and one-hot encoding
# You should get this list from your training data (X.columns)
# Let's try to reconstruct it based on the notebook
original_cols = ['year', 'km_driven', 'mileage(km/ltr/kg)', 'engine', 'seats', 'fuel', 'seller_type', 'transmission', 'owner']
categorical_cols_encoded = ['fuel', 'seller_type', 'transmission', 'owner']

# Recreate the structure of X_train columns
# This is a simplified way and might need adjustment based on your exact encoding
# A better approach is to save the list of columns of X_train during training
# For now, let's assume the order and presence of columns based on the notebook
# You'll need to verify this against your actual X_train.columns
try:
    # Create a dummy dataframe with the same structure as the training data
    # to ensure the columns are in the correct order for the model
    # This requires having access to the original training columns or recreating them accurately
    # For demonstration, let's assume a basic structure based on the notebook
    # A more robust solution would save and load the list of columns
    # Example: expected_columns = joblib.load('training_columns.pkl')

    # Based on the notebook's output of X.columns:
    expected_columns = ['year', 'km_driven', 'mileage(km/ltr/kg)', 'engine', 'seats',
                          'fuel_Diesel', 'fuel_LPG', 'fuel_Petrol',
                          'seller_type_Individual', 'seller_type_Trustmark Dealer',
                          'transmission_Manual',
                          'owner_Fourth & Above Owner', 'owner_Second Owner', 'owner_Third Owner']

except Exception as e:
    st.error(f"Error recreating expected columns: {e}")
    st.stop()


# Streamlit App Title
st.title("Car Selling Price Prediction")

st.write("Enter the car details to get a predicted selling price.")

# Input fields for car features
# The input types should match the data types used in training
year = st.number_input("Manufacturing Year", min_value=1980, max_value=2023, value=2015)
km_driven = st.number_input("Kilometers Driven", min_value=0, value=50000)
fuel = st.selectbox("Fuel Type", ['Petrol', 'Diesel', 'CNG', 'LPG']) # Add other fuel types if present
seller_type = st.selectbox("Seller Type", ['Individual', 'Dealer', 'Trustmark Dealer'])
transmission = st.selectbox("Transmission Type", ['Manual', 'Automatic'])
owner = st.selectbox("Owner Type", ['First Owner', 'Second Owner', 'Third Owner', 'Fourth & Above Owner'])
mileage = st.number_input("Mileage (km/ltr/kg)", min_value=0.0, value=18.0)
engine = st.number_input("Engine (CC)", min_value=0.0, value=1200.0)
# seats = st.number_input("Number of Seats", min_value=1, value=5) # 'seats' had 0 importance, might exclude

# Create a dictionary from user inputs
user_input = {
    'year': year,
    'km_driven': km_driven,
    'mileage(km/ltr/kg)': mileage,
    'engine': engine,
    'seats': 5.0, # Assuming 5 seats based on outlier removal and feature importance
    # Initialize one-hot encoded columns to 0
    'fuel_Diesel': 0, 'fuel_LPG': 0, 'fuel_Petrol': 0,
    'seller_type_Individual': 0, 'seller_type_Trustmark Dealer': 0,
    'transmission_Manual': 0,
    'owner_Fourth & Above Owner': 0, 'owner_Second Owner': 0, 'owner_Third Owner': 0
}

# Apply one-hot encoding based on user input
if fuel == 'Diesel':
    user_input['fuel_Diesel'] = 1
elif fuel == 'LPG':
    user_input['fuel_LPG'] = 1
elif fuel == 'Petrol':
    user_input['fuel_Petrol'] = 1

if seller_type == 'Individual':
    user_input['seller_type_Individual'] = 1
elif seller_type == 'Trustmark Dealer':
    user_input['seller_type_Trustmark Dealer'] = 1

if transmission == 'Manual':
    user_input['transmission_Manual'] = 1

if owner == 'Second Owner':
    user_input['owner_Second Owner'] = 1
elif owner == 'Third Owner':
    user_input['owner_Third Owner'] = 1
elif owner == 'Fourth & Above Owner':
    user_input['owner_Fourth & Above Owner'] = 1


# Create a DataFrame from user input
user_df = pd.DataFrame([user_input])

# Ensure the order of columns in user_df matches the training data (X_train)
# This is critical for the model to make correct predictions
# Add any missing columns with a value of 0 (e.g., if a fuel type wasn't in the training data)
# A robust way is to reindex user_df based on expected_columns
try:
    user_df = user_df.reindex(columns=expected_columns, fill_value=0)
except Exception as e:
    st.error(f"Error reindexing user input DataFrame: {e}")
    st.stop()


# Make prediction when the user clicks a button
if st.button("Predict Selling Price"):
    try:
        # Make prediction using the loaded model
        predicted_price = xgb_model.predict(user_df)

        # Display the prediction
        st.success(f"Predicted Selling Price: â‚¹ {predicted_price[0]:,.2f}")

    except Exception as e:
        st.error(f"An error occurred during prediction: {e}")

st.write("Note: This prediction is based on the trained model and the features you provide.")

# Add instructions on how to run the Streamlit app
st.markdown("""
To run this Streamlit app:
1. Save the code above as `app.py`.
2. Make sure you have Streamlit and joblib installed (`pip install streamlit joblib`).
3. Make sure your trained model file (`xgb_model.pkl`) is in the same directory.
4. Open your terminal or command prompt, navigate to the directory where you saved the files, and run:
   `streamlit run app.py`
""")